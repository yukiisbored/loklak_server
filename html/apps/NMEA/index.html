<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>NMEA Visualizer</title>
	<link rel="stylesheet" href="leaflet.css" />
	<script src="leaflet.js"></script>
	<meta charset="utf-8">
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="Content-Language" content="en, english"/>
	<meta name="author" content="@sudheesh001"> <!-- CHANGE THIS -->
	<link rel="icon" type="image/png" href="../../artwork/favicon.png">
	<link href="../../css/bootstrap.min.css" rel="stylesheet">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.js"></script>
	<style>
	#map { 
		height: 500px;
	}
	</style>
	<script src="../../js/angular.min.js"></script>
    <script src="../../js/angular-route.min.js"></script>
    <script src="../../js/loklak.js"></script>
</head>
<body>
      <nav class="navbar navbar-inverse navbar-fixed-top">
        <div class="container-fluid">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="http://loklak.org"><img src="../../images/loklak_org.png" height="24" style="float:left;">: Advanced Search</a>
          </div>
          <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav navbar-right">
            </ul>
          </div>
        </div>
      </nav>
    <div class="container-fluid" style="margin-top:50px;">
    	<div class="row">
			<div class="form-group"  style="text-align:center;">
				<div class="col-md-8">
					<input id="url" name="url" type="url" placeholder="Enter the data stream URL here" class="form-control input-md"> 
				</div>
				<input type="submit" value="Submit" onclick="getTracking();" class="btn btn-info">
			<div id="map"></div>
			</div>
		</div>
	</div>
	<script>
	function getTracking() {
		var url = document.getElementById('url').value;
		console.log(url);
		var urlComplete = 'http://localhost:9000/api/nmea.txt?stream='+url;
		var centerlat = 52;
		var centerlon =  0;
		// set default zoom level
		var zoomLevel = 2;
		$.getJSON(urlComplete, function (data) {
			console.log(data);
		});
	}
var centerlat = 52;
var centerlon =  0;

// set default zoom level
var zoomLevel = 2;

// initialize map
var map = L.map('map').setView([centerlat, centerlon], zoomLevel);

// Set up the OSM layer
var background = L.tileLayer(
    'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', 
    {maxZoom: 18, opacity: 0.5}).addTo(map);

function onEachDot(feature, layer) {
    layer.bindPopup('<table style="width:180px"><tbody><tr><td><div><b>name:</b></div></td><td><div>' + feature.properties.popup + '</div></td></tr><tr class><td><div><b>time:</b></div></td><td><div>' + feature.properties.time + '</div></td></tr></tbody></table>');
}

//create data and add it to the map
var spiralsteps = 60;
var spiral = make_spiral_json(spiralsteps, [centerlat, centerlon], 0, 1, 0.3, 0.97, 0.1, 0.1);

spiralLayer = L.geoJson(spiral, {
    onEachFeature: onEachDot
});

spiralBounds = spiralLayer.getBounds();
map.fitBounds(spiralBounds);
spiralLayer.addTo(map);

function connectTheDots(data){
    var c = [];
    for(i in data._layers) {
        var x = data._layers[i]._latlng.lat;
        var y = data._layers[i]._latlng.lng;
        c.push([x, y]);
    }
    return c;
}

spiralCoords = connectTheDots(spiralLayer);
var spiralLine = L.polyline(spiralCoords).addTo(map)

/////////////////////////////////////////////////////////////////////////////////////////////
//functions for creating synthetic GeoJSON data//
/////////////////////////////////////////////////////////////////////////////////////////////

//cheapo normrand function
function normish(mean, range) {
    var num_out = ((Math.random() + Math.random() + Math.random() + Math.random() - 2) / 2) * range + mean;
    return num_out;
}

//zero padding for time stamps
function zeroPad(num, places) {
    var zero = places - num.toString().length + 1;
    return Array(+(zero > 0 && zero)).join("0") + num;
}

function make_spiral_json(steps, init_pt, init_angle, init_dist, turn, persistence, wobble, lurch) {

    var spiral = {
        type: "FeatureCollection",
        features: []
    };

    var x = init_pt[1];
    var y = init_pt[0];
    var c = [
        [x, y]
    ];
    var angle = init_angle;
    var dist = init_dist;

    for (var i = 0; i < steps; ++i) {

        var hour = 2 + Math.floor(i / 60);
        var min = zeroPad(i % 60, 2);

        var g = {
            "type": "Point",
                "coordinates": [x, y]
        };
        var p = {
            "id": i,
                "popup": "ping_" + i,
                "time": hour + ':' + min
        };
        spiral.features.push({
            "geometry": g,
                "type": "Feature",
                "properties": p
        });

        x = x + dist * Math.sin(angle) *1.5;
        y = y + dist * Math.cos(angle);
        //        c.push([x, y]);
        dist = dist * (persistence + lurch * normish(0, 1));
        angle = angle + turn + wobble * normish(0, 1);
    }
    return spiral;
}
	</script>
</body>
</html>